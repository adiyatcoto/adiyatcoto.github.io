<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<<<<<<< HEAD
    <title>Power Law Generator | Auto Slope and R² Confidence Detection</title>
=======
    <title>Power Law Generator | Auto slope and R² confidence detection</title>
>>>>>>> 398cd5ae8fc638cba282f56d11cd0e934fb97361
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-pure: #000000;
            --accent: #fbce03;
            --up: #10b981;
            --down: #f43f5e;
            --grid-line: #111827; 
        }

        html, body {
            background-color: #000000 !important;
            color: #f8fafc; 
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        /* Styling Grid */
        .grid line { stroke: var(--grid-line); stroke-opacity: 0.8; shape-rendering: crispEdges; }
        .grid path { stroke-width: 0; }
        .axis-label { font-size: 10px; fill: #475569; font-family: 'JetBrains Mono', monospace; }
        
        /* Candlestick Styling */
        .candle-up { fill: var(--up); stroke: var(--up); stroke-width: 0.5; }
        .candle-down { fill: var(--down); stroke: var(--down); stroke-width: 0.5; }
        .wick { stroke: #1e293b; stroke-width: 0.8; }
        
        /* Power Law Main Line */
        .regression-line { 
            stroke: var(--accent); 
            stroke-width: 3.5; 
            fill: none; 
            pointer-events: visibleStroke;
            transition: stroke-width 0.1s ease-out;
        }

        /* Deviation Bands */
        .band-line { 
            stroke-width: 1.2; 
            fill: none; 
            pointer-events: none; 
            transition: stroke-width 0.1s ease-out, stroke-opacity 0.1s ease-out;
        }

        /* Hitbox */
        .line-hitbox {
            fill: none;
            stroke: transparent;
            stroke-width: 20;
            cursor: crosshair;
            pointer-events: visibleStroke;
        }
        
        .chart-svg { cursor: crosshair; user-select: none; background-color: #000000 !important; }
        
        /* Tooltip */
        .tooltip {
            position: absolute;
            pointer-events: none;
            background: rgba(10, 10, 10, 0.98);
            border: 1px solid #1e293b;
            padding: 12px;
            border-radius: 4px;
            font-size: 11px;
            display: none;
            z-index: 100;
            font-family: 'JetBrains Mono', monospace;
            box-shadow: 0 10px 25px rgba(0,0,0,1);
            transform: translateZ(0);
        }

        .header-ui { 
            background: #000000 !important; 
            border-bottom: 1px solid #0f172a; 
        }
        
        .stat-card {
            background: #050505;
            border: 1px solid #1e293b;
            padding: 6px 14px;
            border-radius: 4px;
            min-width: 150px;
        }

        .chart-area-clip { clip-path: url(#clip); }

        #autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #050505;
            border: 1px solid #1e293b;
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }

        .suggestion-item {
            padding: 10px 14px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #111827;
        }
        .suggestion-item:hover { background: #111827; }

        /* Oscillator Styles */
        .osc-line-main { stroke: #2de1fc; stroke-width: 1.5; fill: none; }
        .osc-line-ref { stroke: #fbce03; stroke-width: 1.5; stroke-dasharray: 4,2; fill: none; opacity: 0.8; }
        .osc-zero-line { stroke: #475569; stroke-width: 1; stroke-dasharray: 2,2; opacity: 0.5; }
        .osc-band-upper { fill: #ff1e56; fill-opacity: 0.08; }
        .osc-band-lower { fill: #2164f3; fill-opacity: 0.08; }
        .osc-label-sigma { font-size: 8px; fill: #64748b; font-family: 'JetBrains Mono', monospace; }

        /* Draggable Windows */
        .draggable-panel {
            position: absolute;
            background: rgba(5, 5, 5, 0.95);
            border: 1px solid #1e293b;
            border-radius: 8px;
            backdrop-filter: blur(8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.8);
            z-index: 50;
            display: flex;
            flex-direction: column; /* FIXED: Corrected CSS property */
            overflow: hidden;
            transition: opacity 0.2s;
        }
        
        .drag-handle {
            cursor: grab;
            user-select: none;
        }
        .drag-handle:active {
            cursor: grabbing;
        }

        .toggle-btn {
            font-size: 9px;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid #1e293b;
            color: #64748b;
            background: #050505;
            cursor: pointer;
            transition: all 0.2s;
        }
        .toggle-btn.active {
            background: #1e293b;
            color: #fbce03;
            border-color: #fbce03;
        }
        .toggle-btn:hover { color: #fff; border-color: #475569; }

        /* Custom Scrollbar for autocomplete */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* --- NEW: SCANNER TABLE STYLES --- */
        .scanner-table th {
            font-size: 8px; color: #475569; text-transform: uppercase;
            padding: 10px 8px; text-align: left; border-bottom: 1px solid #1e293b;
            cursor: pointer; transition: color 0.2s; user-select: none;
        }
        .scanner-table th:hover { color: #fbce03; background: #0f172a; }
        .scanner-table td {
            font-size: 10px; padding: 8px; font-family: 'JetBrains Mono', monospace;
            border-bottom: 1px solid #0f172a;
        }
        .scanner-row { transition: background 0.1s; }
        .scanner-row:hover { background: #1e293b; cursor: pointer; }
        .highlight-score { color: #fbce03; font-weight: bold; }
    </style>
</head>
<body>

    <header class="h-24 header-ui flex items-center justify-between px-10 relative z-20">
        
        <div class="absolute top-0 right-10 w-full flex justify-center pointer-events-none">
            <div class="mt-2 px-6 py-2 bg-[#050505] border border-slate-900 rounded-lg shadow-2xl backdrop-blur-sm max-w-2xl text-center">
                <p class="text-[9px] text-slate-400 font-sans leading-relaxed">
                    <span class="text-yellow-500 font-bold uppercase tracking-widest text-[10px]">Log-Log Power Law Model</span>
                    <span class="block mt-0.5 text-slate-500">
                        This chart uses a <span class="text-slate-300 font-medium">double-logarithmic scale</span> (Time & Price) to visualize exponential network growth as a linear trend. 
                        The central regression line represents the asset's theoretical <span class="text-slate-300 font-medium">"Fair Value"</span> baseline, 
                        while the corridors indicate statistical deviation (<span class="font-serif italic font-bold">σ</span>) often associated with market tops and bottoms.
                    </span>
                </p>
            </div>
        </div>

        <div class="flex items-center space-x-8 z-10 pt-4"> 
            <div class="flex flex-col justify-center">
                <h1 class="text-xl font-black text-white italic tracking-tighter uppercase leading-tight">
                    <span class="text-yellow-500">POWER LAW GENERATOR</span>
                </h1>
                <p class="text-[9px] text-slate-400 font-mono tracking-widest uppercase italic mb-1">Auto slope and R² confidence detection</p>
            </div>
            
            <div class="flex flex-col space-y-1">
                <div class="relative flex items-center bg-black rounded-lg border border-slate-900 group focus-within:border-yellow-500 transition-all">
                    <div class="p-1.5 flex items-center space-x-2">
                        <input id="tickerInput" type="text" value="BTC" autocomplete="off" class="bg-transparent border-none px-3 py-1 text-xs focus:outline-none uppercase w-24 font-bold text-yellow-500" placeholder="Ticker...">
                        <button id="updateBtn" class="bg-yellow-600 hover:bg-yellow-500 text-black px-6 py-2 rounded text-[10px] font-black transition-all uppercase">
                            Sync
                        </button>
                    </div>
                    <div id="autocomplete-list" class="rounded-b-lg shadow-2xl"></div>
                </div>
                <div class="text-[9px] text-slate-600 font-mono italic text-right pr-1">Try: ETH, SOL, ADA, etc...</div>
            </div>
        </div>

        <div class="flex items-center space-x-4 z-10 pt-4">
            <div class="flex flex-col space-y-1 mr-4">
                <div class="text-[8px] text-slate-600 font-bold uppercase tracking-widest text-center">Windows</div>
                <div class="flex space-x-2">
                    <button id="toggleLegend" class="toggle-btn active" onclick="togglePanel('legend-panel', this)">Legend</button>
                    <button id="toggleOsc" class="toggle-btn active" onclick="togglePanel('oscillator-panel', this)">Oscillator</button>
                    <button id="toggleScanner" class="toggle-btn active" onclick="togglePanel('scanner-panel', this)">Scanner</button>
                </div>
            </div>

            <div class="stat-card flex flex-col items-end">
                <span class="text-[8px] text-slate-600 font-bold uppercase tracking-widest leading-none mb-1">Growth Slope (m)</span>
                <span id="slopeVal" class="text-yellow-500 font-mono text-lg font-bold">0.0000</span>
                <span class="text-[7px] text-slate-500 font-mono italic text-right">Linear regression slope</span>
            </div>
            <div class="stat-card flex flex-col items-end">
                <span class="text-[8px] text-slate-600 font-bold uppercase tracking-widest leading-none mb-1">R² Confidence</span>
                <span id="r2Val" class="text-emerald-500 font-mono text-lg font-bold">0.0000</span>
                <span class="text-[7px] text-slate-500 font-mono italic text-right">Coefficient of determination</span>
            </div>
        </div>
    </header>

    <main class="relative w-full h-[calc(100vh-96px)] bg-black overflow-hidden">
        <div id="chart-container" class="w-full h-full"></div>
        <div id="tooltip" class="tooltip"></div>
        
        <div id="legend-panel" class="draggable-panel top-6 left-10 w-[240px]" style="display: flex;">
            <div class="drag-handle h-8 bg-[#050505] border-b border-slate-800 flex items-center justify-between px-3 relative">
                <span class="text-[9px] font-black text-slate-500 tracking-[0.2em] uppercase">Deviation Corridors</span>
                <button onclick="closePanel('legend-panel', 'toggleLegend')" class="text-slate-500 hover:text-white text-xs font-bold px-1 z-50">✕</button>
            </div>
            <div class="p-4 flex flex-col space-y-1.5 overflow-y-auto">
                <div class="flex items-center justify-between text-[9px] font-bold">
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-1 bg-[#ff1e56] rounded-full"></div>
                        <span class="text-[#ff1e56]">CYCLE PEAK</span>
                    </div>
                    <span class="text-slate-600">+2.0σ</span>
                </div>
                <div class="flex items-center justify-between text-[9px] font-medium">
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-[1px] bg-[#ffac41] border-t border-dashed border-[#ffac41]"></div>
                        <span class="text-orange-400">EXTREME HEAT</span>
                    </div>
                    <span class="text-slate-600">+1.5σ</span>
                </div>
                <div class="flex items-center justify-between text-[9px] font-medium">
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-[1px] bg-[#fffb7d] border-t border-dashed border-[#fffb7d]"></div>
                        <span class="text-yellow-100">OVERBOUGHT</span>
                    </div>
                    <span class="text-slate-600">+1.0σ</span>
                </div>
                <div class="flex items-center justify-between text-[10px] font-black my-1 border-y border-slate-900 py-1">
                    <div class="flex items-center space-x-3">
                        <div class="w-4 h-1.5 bg-[#fbce03] rounded-full"></div>
                        <span class="text-yellow-400 font-bold uppercase">Fair Value (Mean)</span>
                    </div>
                    <span class="text-yellow-600">0σ</span>
                </div>
                <div class="flex items-center justify-between text-[9px] font-medium">
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-[1px] bg-[#a3f7bf] border-t border-dashed border-[#a3f7bf]"></div>
                        <span class="text-emerald-300">ACCUMULATION</span>
                    </div>
                    <span class="text-slate-600">-1.0σ</span>
                </div>
                <div class="flex items-center justify-between text-[9px] font-medium">
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-[1px] bg-[#2de1fc] border-t border-dashed border-[#2de1fc]"></div>
                        <span class="text-cyan-400">DEEP VALUE AREA</span>
                    </div>
                    <span class="text-slate-600">-1.5σ</span>
                </div>
                <div class="flex items-center justify-between text-[9px] font-bold">
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-1 bg-[#2164f3] rounded-full"></div>
                        <span class="text-[#2164f3]">GENERATIONAL BOTTOM</span>
                    </div>
                    <span class="text-slate-600">-2.0σ</span>
                </div>
            </div>
        </div>

        <div id="oscillator-panel" class="draggable-panel bottom-10 right-10 w-[840px] h-[440px]" style="display: flex;">
            <div class="drag-handle h-8 border-b border-slate-800 flex items-center justify-between px-3 bg-[#050505] relative flex-shrink-0">
                <div class="flex items-center space-x-2">
                    <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Deviation Oscillator Comparation - Main Ticker VS Reference Ticker</span>
                </div>
                
                <div class="flex items-center space-x-3 z-50">
                    <div class="flex items-center bg-[#0a0a0a] border border-slate-800 rounded px-1.5 py-0.5">
                        <span class="text-[8px] text-yellow-600 font-bold mr-1">CHANGE YOUR REF TICKER:</span>
                        <input id="refInput" type="text" value="BTC" class="bg-transparent border-none text-[9px] font-bold text-yellow-500 w-8 focus:outline-none uppercase text-center">
                    </div>

                    <div class="flex items-center space-x-2 border-l border-slate-800 pl-3">
                        <div class="flex items-center space-x-1">
                            <div class="w-2 h-0.5 bg-cyan-400"></div>
                            <span id="osc-ticker-label" class="text-[8px] text-cyan-400 font-mono font-bold">ASSET</span>
                        </div>
                        <div class="flex items-center space-x-1">
                            <div class="w-2 h-0.5 bg-yellow-500 border-t border-dashed border-yellow-500"></div>
                            <span class="text-[8px] text-yellow-500 font-mono font-bold">REF</span>
                        </div>
                    </div>

                    <button onclick="closePanel('oscillator-panel', 'toggleOsc')" class="text-slate-500 hover:text-white text-xs font-bold px-1 ml-2">✕</button>
                </div>
            </div>
            <div id="oscillator-chart" class="flex-1 w-full relative"></div>
        </div>

        <div id="scanner-panel" class="draggable-panel top-6 right-10 w-[380px] h-[500px]" style="display: flex;">
            <div class="drag-handle h-10 bg-[#050505] border-b border-slate-800 flex items-center justify-between px-4">
                <span class="text-[9px] font-black text-slate-500 tracking-[0.2em] uppercase">Market Alpha Scanner</span>
                <div class="flex items-center space-x-2">
                    <button onclick="runScanner()" class="text-[8px] bg-yellow-600/10 text-yellow-500 px-3 py-1 rounded border border-yellow-500/30 hover:bg-yellow-600 hover:text-black font-bold transition-all">SCAN MARKET (100)</button>
                    <button onclick="closePanel('scanner-panel', 'toggleScanner')" class="text-slate-500 hover:text-white text-xs font-bold px-1">✕</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto">
                <table class="w-full scanner-table">
                    <thead class="sticky top-0 bg-black z-10">
                        <tr>
                            <th onclick="sortScanner('symbol')" title="Sort by Symbol">Asset</th>
                            <th onclick="sortScanner('slope')" title="Sort by Slope">Slope (m)</th>
                            <th onclick="sortScanner('r2')" title="Sort by R²">R² Conf</th>
                            <th onclick="sortScanner('score')" class="text-yellow-500 font-bold" title="Sort by Score">Power Score</th>
                        </tr>
                    </thead>
                    <tbody id="scanner-body">
                        <tr><td colspan="4" class="text-center py-20 text-slate-600 italic">Click "SCAN" to analyze top 100...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="absolute bottom-3 w-full text-center text-[9px] text-slate-600 font-mono tracking-[0.3em] pointer-events-none z-30 uppercase">
            © 2026 Adiyat Coto
        </div>

        <div id="loader" class="absolute inset-0 bg-black flex items-center justify-center z-50">
            <div class="flex flex-col items-center">
                <div class="w-10 h-10 border-2 border-yellow-500/10 border-t-yellow-500 rounded-full animate-spin"></div>
                <p class="mt-4 text-slate-600 text-[9px] font-bold uppercase tracking-[0.3em] font-mono">Calibrating engine...</p>
            </div>
        </div>
    </main>

    <script>
        /**
         * POWER LAW GENERATOR ENGINE (V6.0 - FINAL)
         */

        const GENESIS_BLOCK_TIMESTAMP = 1230940800; 
        const SECONDS_IN_DAY = 86400;
        const HARDCODED_API_KEY = "kucd5ccf2da23b5b008ee549b281c29ec08fd342b5a6bc99e206dfa4bbee162431";

        const container = d3.select("#chart-container");
        const tooltip = d3.select("#tooltip");
        const tickerInput = document.getElementById('tickerInput');
        const refInput = document.getElementById('refInput');
        const autocompleteList = document.getElementById('autocomplete-list');
        const oscTickerLabel = document.getElementById('osc-ticker-label');
        
        let svg, width, height, xScale, yScale, xAxis, yAxis, gX, gY, chartArea;
        let originalXScale, originalYScale;
        let globalData = [], regressionMeta = {};
        let topAssets = []; 
        let currentAnchorTime = GENESIS_BLOCK_TIMESTAMP;
        
        // Dynamic Reference Storage
        let refData = [];
        let refMeta = {};
        let currentRefSymbol = "BTC";

        // Scanner Variables
        let scannerData = [];
        let sortKey = 'score', sortDir = -1;

        const margin = { top: 40, right: 90, bottom: 60, left: 20 };

        const BANDS_CONFIG = [
            { dev: 2.0, color: '#ff1e56', opacity: 0.8, dash: 'none', weight: 2, label: 'Cycle Peak' }, 
            { dev: 1.5, color: '#ffac41', opacity: 0.5, dash: '6,4', weight: 1, label: 'Extreme Heat' },   
            { dev: 1.0, color: '#fffb7d', opacity: 0.5, dash: '4,4', weight: 1, label: 'Overbought' }, 
            { dev: 0.5, color: '#fbce03', opacity: 0.15, dash: '2,4', weight: 0.8, label: 'Bullish Buffer' }, 
            { dev: -0.5, color: '#fbce03', opacity: 0.15, dash: '2,4', weight: 0.8, label: 'Bearish Buffer' },
            { dev: -1.0, color: '#a3f7bf', opacity: 0.5, dash: '4,4', weight: 1, label: 'Accumulation' }, 
            { dev: -1.5, color: '#2de1fc', opacity: 0.5, dash: '6,4', weight: 1, label: 'Deep Value' },   
            { dev: -2.0, color: '#2164f3', opacity: 0.8, dash: 'none', weight: 2, label: 'Generational Bottom' }  
        ];

        // --- UI & DRAG LOGIC ---

        function togglePanel(panelId, btn) {
            const panel = document.getElementById(panelId);
            if (panel.style.display === 'none') {
                panel.style.display = 'flex';
                btn.classList.add('active');
            } else {
                panel.style.display = 'none';
                btn.classList.remove('active');
            }
        }

        function closePanel(panelId, btnId) {
            document.getElementById(panelId).style.display = 'none';
            document.getElementById(btnId).classList.remove('active');
        }

        function makeDraggable(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const header = elmnt.querySelector('.drag-handle');
            
            // Allow clicking inside input without dragging
            const inputs = header.querySelectorAll('input, button');
            inputs.forEach(input => {
                input.onmousedown = (e) => e.stopPropagation();
            });
            
            if (header) {
                header.onmousedown = dragMouseDown;
            } else {
                elmnt.onmousedown = dragMouseDown;
            }

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                elmnt.style.bottom = 'auto';
                elmnt.style.right = 'auto';
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        // Initialize Draggables
        makeDraggable(document.getElementById("legend-panel"));
        makeDraggable(document.getElementById("oscillator-panel"));
        // ADDED: Init Scanner Drag
        makeDraggable(document.getElementById("scanner-panel"));


        // --- DATA & CHART LOGIC ---

        async function fetchAutocompleteData() {
            try {
                const res = await fetch(`https://min-api.cryptocompare.com/data/top/mktcapfull?limit=100&tsym=USD&api_key=${HARDCODED_API_KEY}`);
                const json = await res.json();
                if (json.Data) {
                    topAssets = json.Data.map(item => ({
                        symbol: item.CoinInfo.Name,
                        fullName: item.CoinInfo.FullName
                    }));
                }
            } catch (e) { console.error("Error fetching coins."); }
        }

        tickerInput.addEventListener('input', () => {
            const val = tickerInput.value.toUpperCase();
            autocompleteList.innerHTML = '';
            if (!val) { autocompleteList.style.display = 'none'; return; }
            const filtered = topAssets.filter(a => a.symbol.includes(val) || a.fullName.toUpperCase().includes(val)).slice(0, 10);
            if (filtered.length > 0) {
                autocompleteList.style.display = 'block';
                filtered.forEach(asset => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerHTML = `<span class="text-yellow-500 font-bold">${asset.symbol}</span> <span class="text-slate-500 text-[10px]">${asset.fullName}</span>`;
                    div.onclick = () => {
                        tickerInput.value = asset.symbol;
                        autocompleteList.style.display = 'none';
                        triggerUpdate();
                    };
                    autocompleteList.appendChild(div);
                });
            } else { autocompleteList.style.display = 'none'; }
        });

        document.addEventListener('click', (e) => {
            if (e.target !== tickerInput) autocompleteList.style.display = 'none';
        });

        function setupCanvas() {
            container.selectAll("*").remove();
            const rect = container.node().getBoundingClientRect();
            width = rect.width - margin.left - margin.right;
            height = rect.height - margin.top - margin.bottom;

            svg = container.append("svg")
                .attr("width", rect.width)
                .attr("height", rect.height)
                .attr("class", "chart-svg")
                .style("background-color", "#000000");

            svg.append("rect").attr("width", rect.width).attr("height", rect.height).attr("fill", "#000000");
            svg.append("defs").append("clipPath").attr("id", "clip").append("rect").attr("width", width).attr("height", height);
            
            const mainGroup = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
            gX = mainGroup.append("g").attr("class", "grid axis-label").attr("transform", `translate(0,${height})`);
            gY = mainGroup.append("g").attr("class", "grid axis-label").attr("transform", `translate(${width}, 0)`);
            chartArea = mainGroup.append("g").attr("class", "chart-area-clip");
            
            const zoom = d3.zoom().scaleExtent([0.01, 20000]).on("zoom", zoomed);
            svg.call(zoom);
        }

        function calculateRegression(data) {
            const n = data.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0, sumYY = 0;
            data.forEach(d => {
                const lnX = Math.log(d.days);
                const lnY = Math.log(d.close);
                sumX += lnX; sumY += lnY;
                sumXY += lnX * lnY;
                sumXX += lnX * lnX;
                sumYY += lnY * lnY;
            });
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            const r = (n * sumXY - sumX * sumY) / Math.sqrt((n * sumXX - sumX * sumX) * (n * sumYY - sumY * sumY));
            const residuals = data.map(d => Math.log(d.close) - (slope * Math.log(d.days) + intercept));
            const stdDev = Math.sqrt(residuals.map(r => r * r).reduce((a, b) => a + b) / n);
            return { slope, intercept, r2: r * r, stdDev };
        }

        // --- REFERENCE LOADER ---
        async function loadReference(symbol) {
            if (!symbol) return;
            currentRefSymbol = symbol.toUpperCase();
            
            try {
                const response = await fetch(`https://min-api.cryptocompare.com/data/v2/histoday?fsym=${currentRefSymbol}&tsym=USD&allData=true&api_key=${HARDCODED_API_KEY}`);
                const json = await response.json();
                if (json.Response === "Error") throw new Error(json.Message);
                const rawData = json.Data.Data.filter(d => d.close > 0);
                
                const data = rawData.map(d => ({
                    ...d,
                    days: Math.max(1, (d.time - GENESIS_BLOCK_TIMESTAMP) / SECONDS_IN_DAY),
                    date: new Date(d.time * 1000)
                }));

                const meta = calculateRegression(data);
                
                // Pre-calculate Ratios
                refData = data.map(d => {
                    const predicted = Math.exp(meta.slope * Math.log(d.days) + meta.intercept);
                    const ratio = d.close / predicted; 
                    return { time: d.time, ratio: ratio, date: d.date };
                });
                refMeta = meta;
            } catch (e) {
                console.error("Failed to load reference", e);
                refData = []; 
            }
        }

        // --- LOG-SYMMETRIC OSCILLATOR DRAWING FUNCTION ---
        function updateOscillator(symbolData, symbolMeta, symbol) {
            const oscContainer = d3.select("#oscillator-chart");
            oscContainer.selectAll("*").remove();

            const w = oscContainer.node().getBoundingClientRect().width;
            const h = oscContainer.node().getBoundingClientRect().height;
            const m = {t: 10, r: 40, b: 20, l: 10};
            const innerW = w - m.l - m.r;
            const innerH = h - m.t - m.b;

            const svg = oscContainer.append("svg").attr("width", w).attr("height", h);
            const g = svg.append("g").attr("transform", `translate(${m.l},${m.t})`);

            // 1. Calculate Ratio (Price / FairValue)
            const coinRatios = symbolData.map(d => {
                const predicted = Math.exp(symbolMeta.slope * Math.log(d.days) + symbolMeta.intercept);
                const ratio = d.close / predicted;
                return { time: d.time, ratio: ratio, date: d.date };
            });

            // 2. Calculate Sigma Ratios for Zones
            const rPlus2 = Math.exp(2 * symbolMeta.stdDev);
            const rMinus2 = Math.exp(-2 * symbolMeta.stdDev);

            // 3. Determine Log Domain
            let maxRatio = d3.max(coinRatios, d => d.ratio);
            let minRatio = d3.min(coinRatios, d => d.ratio);
            
            maxRatio = Math.max(maxRatio, rPlus2);
            minRatio = Math.min(minRatio, rMinus2);

            // Symmetric boundary
            const boundary = Math.max(maxRatio, 1/minRatio) * 1.1; 
            
            const oscY = d3.scaleLog().domain([1/boundary, boundary]).range([innerH, 0]);
            const oscX = d3.scaleTime().domain(d3.extent(coinRatios, d => d.date)).range([0, innerW]);

            // 4. Draw Zones
            g.append("rect").attr("x", 0).attr("width", innerW).attr("y", 0)
                .attr("height", Math.max(0, oscY(rPlus2))).attr("class", "osc-band-upper");
            
            g.append("rect").attr("x", 0).attr("width", innerW).attr("y", oscY(rMinus2))
                .attr("height", Math.max(0, innerH - oscY(rMinus2))).attr("class", "osc-band-lower");

            g.append("line").attr("x1", 0).attr("x2", innerW).attr("y1", oscY(1)).attr("y2", oscY(1)).attr("class", "osc-zero-line");
            
            g.append("text").attr("x", innerW + 4).attr("y", oscY(rPlus2) + 3).text("+2σ").attr("class", "osc-label-sigma");
            g.append("text").attr("x", innerW + 4).attr("y", oscY(rMinus2) + 3).text("-2σ").attr("class", "osc-label-sigma");

            // 5. Axes
            const yAxisOsc = d3.axisRight(oscY)
                .tickValues([boundary, rPlus2, 1, rMinus2, 1/boundary]) 
                .tickSize(innerW)
                .tickFormat(d => {
                    const pct = (d - 1) * 100;
                    return (pct > 0 ? "+" : "") + Math.round(pct) + "%";
                });

            g.append("g").attr("class", "grid axis-label").call(yAxisOsc)
                .call(g => g.select(".domain").remove())
                .call(g => g.selectAll(".tick line").attr("stroke-opacity", 0.1).attr("x1", -innerW));
            
            const xAxisOsc = d3.axisBottom(oscX).ticks(4);
            g.append("g").attr("class", "axis-label").attr("transform", `translate(0,${innerH})`).call(xAxisOsc).select(".domain").remove();

            // 6. Draw Lines
            const lineGen = d3.line().x(d => oscX(d.date)).y(d => oscY(d.ratio));

            // Draw Reference Line (if not self)
            if (symbol !== currentRefSymbol && refData.length > 0) {
                // Filter ref data to view range
                const refVisible = refData.filter(d => d.time >= coinRatios[0].time && d.time <= coinRatios[coinRatios.length-1].time);
                g.append("path").datum(refVisible).attr("class", "osc-line-ref").attr("d", lineGen);
            }

            // Draw Asset Line
            g.append("path").datum(coinRatios).attr("class", "osc-line-main").attr("d", lineGen);
        }

        // Lightweight Hover Function
        function handleLineHover(event, d, isMean = false, index = null) {
            const [mx, my] = d3.pointer(event, chartArea.node());
            const days = xScale.invert(mx);
            const dev = isMean ? 0 : d.dev;
            const label = isMean ? 'Fair Value (Mean)' : d.label;
            const color = isMean ? '#fbce03' : d.color;
            
            const price = Math.exp(regressionMeta.slope * Math.log(days) + regressionMeta.intercept + (dev * regressionMeta.stdDev));
            const date = new Date(currentAnchorTime * 1000);
            date.setDate(date.getDate() + days);

            tooltip.style("display", "block").html(`
                <div class="text-[10px] font-black uppercase mb-1" style="color: ${color}">${label}</div>
                <div class="border-t border-slate-800 pt-1.5 mt-1.5 grid grid-cols-2 gap-x-4 gap-y-1 text-[10px]">
                    <span class="text-slate-500 uppercase font-mono">Date:</span> <span>${date.toLocaleDateString('en-US', {year:'numeric', month:'short', day:'numeric'})}</span>
                    <span class="text-slate-500 uppercase font-mono">Price:</span> <span class="text-white font-bold font-mono">$${price.toLocaleString(undefined, {maximumFractionDigits: 2})}</span>
                    <span class="text-slate-500 uppercase font-mono">Sigma:</span> <span>${dev.toFixed(1)}σ</span>
                </div>
            `);
            tooltip.style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 15) + "px");

            if (isMean) {
                chartArea.select(".regression-line").style("stroke-width", "5px");
            } else if (index !== null) {
                chartArea.select(`.band-line-${index}`)
                    .style("stroke-opacity", "1.0")
                    .style("stroke-width", (d.weight + 2) + "px");
            }
        }

        function removeGlow(index = null) {
            tooltip.style("display", "none");
            if (index === null) {
                chartArea.select(".regression-line").style("stroke-width", "3.5px");
            } else {
                const b = BANDS_CONFIG[index];
                chartArea.select(`.band-line-${index}`)
                    .style("stroke-opacity", b.opacity)
                    .style("stroke-width", b.weight + "px");
            }
        }

        function updateElements(currXScale, currYScale) {
            xScale = currXScale;
            yScale = currYScale;
            gX.call(xAxis.scale(currXScale));
            gY.call(yAxis.scale(currYScale));

            const minD = currXScale.domain()[0];
            const maxD = currXScale.domain()[1];
            const xRange = d3.range(Math.log(Math.max(0.1, minD)), Math.log(maxD), (Math.log(maxD) - Math.log(Math.max(0.1, minD)))/250).map(Math.exp);

            const lineGen = d3.line().x(d => currXScale(d));

            chartArea.select(".regression-line")
                .attr("d", lineGen.y(d => currYScale(Math.exp(regressionMeta.slope * Math.log(d) + regressionMeta.intercept)))(xRange));

            BANDS_CONFIG.forEach((b, i) => {
                const pathData = lineGen.y(d => currYScale(Math.exp(regressionMeta.slope * Math.log(d) + regressionMeta.intercept + (b.dev * regressionMeta.stdDev))))(xRange);
                chartArea.select(`.band-line-${i}`).attr("d", pathData);
                chartArea.select(`.hitbox-${i}`).attr("d", pathData);
            });

            const candles = chartArea.selectAll(".candle-group");
            candles.select(".wick").attr("x1", d => currXScale(d.days)).attr("x2", d => currXScale(d.days)).attr("y1", d => currYScale(d.high)).attr("y2", d => currYScale(d.low));
            candles.select("rect").attr("x", d => currXScale(d.days) - 1.25).attr("y", d => currYScale(Math.max(d.open, d.close))).attr("height", d => Math.max(0.6, Math.abs(currYScale(d.open) - currYScale(d.close))));
        }

        function zoomed(event) {
            updateElements(event.transform.rescaleX(originalXScale), event.transform.rescaleY(originalYScale));
        }

        async function analyze(symbol) {
            d3.select("#loader").style("display", "flex");
            oscTickerLabel.innerText = symbol;
            
            try {
                // 1. Fetch Main Ticker Data
                const response = await fetch(`https://min-api.cryptocompare.com/data/v2/histoday?fsym=${symbol.toUpperCase()}&tsym=USD&allData=true&api_key=${HARDCODED_API_KEY}`);
                const json = await response.json();
                if (json.Response === "Error") throw new Error(json.Message);
                const rawData = json.Data.Data.filter(d => d.close > 0);
                const firstTimestamp = rawData[0].time;
                currentAnchorTime = symbol.toUpperCase() === 'BTC' ? GENESIS_BLOCK_TIMESTAMP : firstTimestamp;

                globalData = rawData.map(d => ({
                    ...d,
                    days: Math.max(1, (d.time - currentAnchorTime) / SECONDS_IN_DAY),
                    date: new Date(d.time * 1000)
                }));

                regressionMeta = calculateRegression(globalData);
                d3.select("#slopeVal").text(regressionMeta.slope.toFixed(4));
                d3.select("#r2Val").text(regressionMeta.r2.toFixed(4));
                
                // 2. Fetch Reference Data (if needed)
                const refSymbol = refInput.value.toUpperCase();
                if (refSymbol !== currentRefSymbol || refData.length === 0) {
                     await loadReference(refSymbol);
                }

                // 3. Update Oscillator
                updateOscillator(globalData, regressionMeta, symbol.toUpperCase());

                // 4. Draw Main Chart
                originalXScale = d3.scaleLog().domain([d3.min(globalData, d => d.days), d3.max(globalData, d => d.days) * 3]).range([0, width]);
                originalYScale = d3.scaleLog().domain([d3.min(globalData, d => d.low) * 0.4, d3.max(globalData, d => d.high) * 12]).range([height, 0]);

                xScale = originalXScale;
                yScale = originalYScale;

                xAxis = d3.axisBottom(originalXScale).ticks(10).tickFormat(d => {
                    const date = new Date(currentAnchorTime * 1000);
                    date.setDate(date.getDate() + d);
                    return date.getFullYear();
                }).tickSize(-height);

                yAxis = d3.axisRight(originalYScale).ticks(15, d => {
                    if (d >= 1000000) return "$" + (d/1000000).toLocaleString() + "M";
                    if (d >= 1000) return "$" + (d/1000).toLocaleString() + "k";
                    if (d >= 1) return "$" + d.toLocaleString();
                    return "$" + d.toFixed(3);
                }).tickSize(-width);

                chartArea.selectAll("*").remove();

                BANDS_CONFIG.forEach((b, i) => {
                    chartArea.append("path")
                        .attr("class", `band-line band-line-${i}`)
                        .attr("stroke", b.color)
                        .attr("stroke-opacity", b.opacity)
                        .attr("stroke-width", b.weight);
                    if (b.dash !== 'none') {
                        chartArea.select(`.band-line-${i}`).attr("stroke-dasharray", b.dash);
                    }

                    chartArea.append("path")
                        .attr("class", `line-hitbox hitbox-${i}`)
                        .on("mouseover", (e) => handleLineHover(e, b, false, i))
                        .on("mousemove", (e) => handleLineHover(e, b, false, i))
                        .on("mouseout", () => removeGlow(i));
                });

                chartArea.append("path")
                    .attr("class", "regression-line")
                    .on("mouseover", (e) => handleLineHover(e, null, true))
                    .on("mousemove", (e) => handleLineHover(e, null, true))
                    .on("mouseout", () => removeGlow());

                const candleGroups = chartArea.selectAll(".candle-group").data(globalData).enter().append("g").attr("class", "candle-group");
                candleGroups.append("line").attr("class", "wick");
                candleGroups.append("rect").attr("width", 2.5).attr("class", d => d.close >= d.open ? "candle-up" : "candle-down")
                    .on("mouseover", (e, d) => {
                        const dev = (Math.log(d.close) - (regressionMeta.slope * Math.log(d.days) + regressionMeta.intercept)) / regressionMeta.stdDev;
                        tooltip.style("display", "block").html(`
                            <div class="text-white font-bold border-b border-slate-900 pb-1.5 mb-2 font-mono">${d.date.toLocaleDateString('en-US', {year:'numeric', month:'short', day:'numeric'})}</div>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-[10px] font-mono">
                                <span class="text-slate-500 uppercase">Price:</span> <span class="text-yellow-500 font-bold">$${d.close.toLocaleString()}</span>
                                <span class="text-slate-500 uppercase">Age:</span> <span>${Math.floor(d.days)} d</span>
                                <span class="text-slate-500 uppercase">Dev:</span> <span style="color: ${dev > 0 ? '#ff1e56' : '#2de1fc'}" class="font-bold">${dev.toFixed(3)}σ</span>
                                <span class="text-slate-500 uppercase">Zone:</span> <span class="text-slate-300 italic">
                                    ${dev > 1.8 ? 'Peak' : dev > 1.3 ? 'Extreme' : dev > 0.8 ? 'Overbought' : dev > -0.8 ? 'Fair' : dev > -1.3 ? 'Accumulate' : dev > -1.8 ? 'Deep Value' : 'Bottom'}
                                </span>
                            </div>
                        `);
                    })
                    .on("mousemove", (e) => tooltip.style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 15) + "px"))
                    .on("mouseout", () => tooltip.style("display", "none"));

                updateElements(originalXScale, originalYScale);
            } catch (err) { 
                console.error(err); 
                alert("Failed to load chart data. Please check the API key or try again later.\nError: " + err.message);
            }
            finally { d3.select("#loader").style("display", "none"); }
        }

        async function triggerUpdate() {
            setupCanvas();
            await loadReference(refInput.value);
            await analyze(tickerInput.value);
        }

        // --- NEW SCANNER LOGIC ---
        async function runScanner() {
            const body = document.getElementById('scanner-body');
            const limit = 100; // Scan Top 100
            
            try {
                body.innerHTML = `<tr><td colspan="4" class="text-center py-20 text-yellow-500 font-bold animate-pulse">FETCHING MARKET DATA...</td></tr>`;

                // 1. Get Top 100 List
                const res = await fetch(`https://min-api.cryptocompare.com/data/top/mktcapfull?limit=${limit}&tsym=USD&api_key=${HARDCODED_API_KEY}`);
                const listJson = await res.json();
                
                if (!listJson.Data) throw new Error("API Limit");
                
                scannerData = [];
                let count = 0;

                // 2. Iterate and Fetch History
                for (const item of listJson.Data) {
                    const symbol = item.CoinInfo.Name;
                    count++;
                    
                    // Show live progress
                    body.innerHTML = `<tr><td colspan="4" class="text-center py-20 text-yellow-500 font-bold font-mono">SCANNING: ${symbol} (${count}/${limit})</td></tr>`;

                    try {
                        const histRes = await fetch(`https://min-api.cryptocompare.com/data/v2/histoday?fsym=${symbol}&tsym=USD&allData=true&api_key=${HARDCODED_API_KEY}`);
                        const json = await histRes.json();
                        
                        if (json.Response === 'Success' && json.Data && json.Data.Data) {
                            const raw = json.Data.Data.filter(d => d.close > 0);
                            
                            // Only include coins with >180 days history for valid regression
                            if (raw.length > 180) { 
                                const anchor = symbol === 'BTC' ? GENESIS_BLOCK_TIMESTAMP : raw[0].time;
                                const clean = raw.map(d => ({ close: d.close, days: Math.max(1, (d.time - anchor) / SECONDS_IN_DAY) }));
                                const stats = calculateRegression(clean);
                                const score = stats.slope * stats.r2; // Power Score Algo
                                
                                scannerData.push({ symbol, slope: stats.slope, r2: stats.r2, score: score });
                            }
                        }
                        
                        // Tiny delay to be nice to API
                        await new Promise(r => setTimeout(r, 20)); 

                    } catch (e) { console.warn(`Skipped ${symbol}`); }
                }
                
                // 3. Done scanning, sort by score default
                sortScanner('score', true); 

            } catch (e) {
                body.innerHTML = `<tr><td colspan="4" class="text-center py-20 text-red-500 font-bold">SCAN ERROR<br><span class="text-[9px]">API Key Exhausted</span></td></tr>`;
            }
        }

        function sortScanner(key, force = false) {
            if (!force && sortKey === key) sortDir *= -1;
            else if (!force) sortDir = -1;
            sortKey = key;
            
            scannerData.sort((a, b) => (a[key] > b[key] ? 1 : -1) * sortDir);
            renderScanner();
        }

        function renderScanner() {
            const body = document.getElementById('scanner-body');
            body.innerHTML = scannerData.map(d => `
                <tr class="scanner-row" onclick="loadFromScanner('${d.symbol}')">
                    <td class="text-white font-bold">${d.symbol}</td>
                    <td class="text-slate-400">${d.slope.toFixed(4)}</td>
                    <td class="text-slate-400">${d.r2.toFixed(4)}</td>
                    <td class="highlight-score">${d.score.toFixed(4)}</td>
                </tr>
            `).join('');
        }

        // Helper to load ticker from scanner click
        function loadFromScanner(symbol) {
            tickerInput.value = symbol;
            triggerUpdate();
        }

        window.onload = async () => { 
            setupCanvas();
            makeDraggable(document.getElementById("legend-panel"));
            makeDraggable(document.getElementById("oscillator-panel"));
            makeDraggable(document.getElementById("scanner-panel"));
            fetchAutocompleteData();
            // Load initial reference BTC first
            await loadReference("BTC");
            await analyze("BTC");
        };
        window.onresize = () => { setupCanvas(); analyze(tickerInput.value); };
        d3.select("#updateBtn").on("click", triggerUpdate);
        refInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') triggerUpdate() });
    </script>
</body>
</html>
